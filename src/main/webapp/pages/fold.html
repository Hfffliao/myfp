<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <title>éœ–ä¾</title>
    <!-- å¼•å…¥å­—ä½“å›¾æ ‡ -->
    <script>
        // å®šä¹‰å…¨å±€å˜é‡å­˜å‚¨ä¸Šä¸‹æ–‡è·¯å¾„
        function getContextPath() {
            const pathName = window.location.pathname;
            //   console.log('pathName:', pathName);
            // æŸ¥æ‰¾ç¬¬äºŒä¸ª / çš„ç´¢å¼•
            const Index = pathName.indexOf('p');
            return pathName.substring(0, Index - 1);
        }
        const contextPath = getContextPath();
        //  console.log('ä¸Šä¸‹æ–‡è·¯å¾„:', contextPath);

        // åŠ¨æ€åŠ è½½è„šæœ¬çš„å‡½æ•°
        function loadScript(src, onLoad, onError) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = onLoad;
            script.onerror = onError;
            document.head.appendChild(script);
        }

        // åŠ¨æ€åŠ è½½æ ·å¼è¡¨çš„å‡½æ•°
        function loadStylesheet(href, onLoad, onError) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            link.onload = onLoad;
            link.onerror = onError;
            document.head.appendChild(link);
        }

        // åŠ è½½ hangbege.js
        loadScript(
            contextPath + '/pages/css/hangbege.js',
            () => {
                // console.log('hangbege.js åŠ è½½æˆåŠŸ');
            },
            () => console.error('hangbege.js åŠ è½½å¤±è´¥')
        );

        // åŠ è½½ linyistyle.css
        loadStylesheet(
            contextPath + '/pages/css/linyistyle.css',
            () => { },//console.log('linyistyle.css åŠ è½½æˆåŠŸ'),
            () => console.error('linyistyle.css åŠ è½½å¤±è´¥')
        );
    </script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* CSSå˜é‡å®šä¹‰ */

        /* å¡ç‰‡å¸ƒå±€ */
        .card-container {
            max-width: none;
            margin: 0rem;
            padding: 5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            background: rgba(198, 18, 18, 0.5);

        }


        .file-system-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .file-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 0px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }

        .file-item:hover {
            background-color: #f9f9f9;
        }

        .file-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        .folder {
            color: #ffd700;
        }

        .file {
            color: #6c757d;
        }

        .file-name {
            flex-grow: 1;
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #bb2d3b;
        }

        .new-folder-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
        }

        .rename-btn {
            background-color: #1259dd;
            margin-left: 10px;
        }

        .rename-btn:hover {
            background-color: #218838;
        }

        .rename-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
            margin-right: 10px;
        }

        .fileshow {
            width: 100%;
            height: 800px;
            z-index: 1000;
            position: fixed;
            /* å›ºå®šå®šä½ */
            top: 100px;
            display: none;
            padding: 10px 20px 10px 20px;
        }
        .moreoperation{
            position: fixed;
            z-index: 1000;
            display: none;
            width: 50%;
            height: 50%;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
              /* å±…ä¸­å®šä½ */
              top: 50%;         /* é¡¶éƒ¨è·ç¦»è§†å£50% */
            left: 50%;        /* å·¦ä¾§è·ç¦»è§†å£50% */
            transform: translate(-50%, -50%); /* å‘å·¦ä¸Šæ–¹åç§»è‡ªèº«å®½é«˜çš„50%ï¼Œå®ç°å±…ä¸­ */
        }
    </style>
</head>

<body>
    <div id="header"></div>
    <main>
        <!-- æ–‡ä»¶å±•ç¤ºçª—å£ -->
        <div id="fileshow" class="fileshow">
            <button id="closefileshow" onclick="closefileshow()">å…³é—­</button>
            <button id="downloadlink">ä¸‹è½½</button>
            <!-- //æ–‡ä»¶å±•ç¤ºé¡¹ç›® -->
            <div id="fileshowcontent" style="width: 100%;height: 500px;">
            </div>
        </div>
        <!-- æ›´å¤šæ“ä½œæŒ‰é’®çš„é€‰é¡¹ -->
        <div id="moreoperation" class="moreoperation">
            <button onclick="opensealfile()">å°å°æ–‡ä»¶</button>
             <!-- æ·»åŠ å…³é—­æŒ‰é’® -->
             <button onclick="closeMoreOperation()" style="float: right; background: #dc3545; margin-bottom: 10px;">Ã—</button>
            <div style="margin: 15px 0;">
                <label for="sealTime" style="margin-right: 8px;">è§£å°æ—¶é—´:</label>
                <input type="datetime-local" id="sealTime" name="sealTime" required>
                <button onclick="sealfile()">ç¡®å®šå°å°</button>
            </div>
        </div>

        <section class="hero">
            <div class="hero-content">
                <h1>æ–‡ä»¶ç³»ç»Ÿ</h1>
                <h2><span id="message">åœ¨æ­¤å¤„æ·»åŠ ï¼Œåˆ é™¤ï¼Œç§»åŠ¨ï¼Œä¸Šä¼ æˆ–æ˜¯é¢„è§ˆæ‚¨çš„æ–‡ä»¶</span></h2>
            </div>
        </section>
        <div class="card-container " style="min-height: 500px;">
            <div class="file-system-container">
                <div class="toolbar" id="toolbar">
                    <button onclick="createNewFolder()">æ–°å»ºæ–‡ä»¶å¤¹</button>
                    <!-- æ–°å¢ä¸Šä¼ æ–‡ä»¶å¤¹æŒ‰é’® -->
                    <button onclick="document.getElementById('folder-input').click()">ä¸Šä¼ æ–‡ä»¶å¤¹</button>
                    <!-- æ–°å¢ä¸Šä¼ æ–‡ä»¶æŒ‰é’® -->
                    <button onclick="document.getElementById('file-input').click()">ä¸Šä¼ æ–‡ä»¶</button>
                    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´  -->
                    <input type="file" id="file-input" style="display: none;" onchange="handleFolderUpload(this)"
                        multiple>
                    <!-- éšè—çš„æ–‡ä»¶å¤¹è¾“å…¥å…ƒç´  -->
                    <input type="file" id="folder-input" style="display: none;" onchange="handleFolderUpload(this)"
                        webkitdirectory directory>
                </div>
                <div id="new-folder-form" style="display: none;">
                    <input type="text" class="new-folder-input" id="new-folder-name" placeholder="è¾“å…¥æ–‡ä»¶å¤¹åç§°">
                    <button onclick="saveNewFolder()">ä¿å­˜</button>
                    <button onclick="cancelNewFolder()">å–æ¶ˆ</button>
                </div>
                <div id="path-display">å½“å‰è·¯å¾„: /</div>
                <ul class="file-list" id="file-list">
                    <!-- æ–‡ä»¶å’Œæ–‡ä»¶å¤¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                </ul>
            </div>
        </div>
    </main>
    <div id="footer"></div>
</body>



<script>
    function closefileshow() {
        document.getElementById('fileshow').style.display = 'none';
    }

    // æ–°å¢ï¼šå…³é—­ moreoperation é¢æ¿çš„å‡½æ•°
    function closeMoreOperation() {
        document.getElementById('moreoperation').style.display = 'none';
    }

    ///////åˆ›å»ºæ–‡ä»¶å¤¹
    function createNewFolder() {
        // éšè—å…¶ä»–è¡¨å•
        const otherForm = document.getElementById('toolbar');
        otherForm.style.display = 'none';
        // æ˜¾ç¤ºæ–°å»ºæ–‡ä»¶å¤¹è¡¨å•
        const newFolderForm = document.getElementById('new-folder-form');
        newFolderForm.style.display = 'block';
    }
    // ä¿å­˜æ–°å»ºæ–‡ä»¶å¤¹
    async function saveNewFolder() {

        //è·å–æ–°å»ºæ–‡ä»¶å¤¹è¡¨å•
        const folderName = document.getElementById('new-folder-name').value.trim();
        if (folderName) {
            try {
                const pathParam = currentPath.join('/');
                const response = await fetch('/create-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: pathParam,
                        name: folderName
                    })
                });

                if (!response.ok) {
                    throw new Error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
                }

                await initFileList();
            } catch (error) {
                console.error('åˆ›å»ºæ–‡ä»¶å¤¹å‡ºé”™:', error);
            }
        }
        cancelNewFolder();
    }
    //å…³é—­æ–°å»ºæ–‡ä»¶å¤¹  
    function cancelNewFolder() {
        document.getElementById('new-folder-form').style.display = 'none';
        document.getElementById('toolbar').style.display = 'block';
    }

    ///////// åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
    async function deleteItem(name,type,id) {
        try {
            let joincurrentPath = currentPath.join('/');
            //å¦‚æœjoincurrentPathä¸ä¸ºç©ºï¼Œä¸”ä¸ä»¥/ç»“å°¾ï¼Œæ·»åŠ /æ¥æ„é€ åˆæ³•url
            console.log(joincurrentPath);
            if (joincurrentPath.length > 0) {
                joincurrentPath += '/';
            }
            // å¯¹è·¯å¾„å’Œæ–‡ä»¶åè¿›è¡Œ URL ç¼–ç 
            const encodedPath = encodeURIComponent(joincurrentPath);
            const encodedName = encodeURIComponent(name);
            const encodedid = encodeURIComponent(id);

            let url = `${endpointPath}/file`;
            url+=`?filepn=${encodedPath}${encodedName}&fileid=${encodedid}&type=${type}`
            const response = await fetch(url, {
                method: 'DELETE',
                credentials: "include"
            });
            console.log('id='+id+';type='+type);
            if (!response.ok) {
                throw new Error('åˆ é™¤æ–‡ä»¶/æ–‡ä»¶å¤¹å¤±è´¥');
            }
            await getFilePathSystemAndInit();
        } catch (error) {
            await getFilePathSystemAndInit();
            console.error('åˆ é™¤æ–‡ä»¶/æ–‡ä»¶å¤¹å‡ºé”™:', error);
        }
    }
    ///////// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    async function handleFileUpload(input) {
        const files = Array.from(input.files);
        const formData = new FormData();
        let tatolsize = 0;//è®°å½•æ€»å¤§å°


        files.forEach(file => {
            tatolsize += file.size;
        });

        //æ·»åŠ å¤§å°
        formData.append('tatolsize', tatolsize);
        // å°†æ–‡ä»¶æ·»åŠ åˆ° FormData
        files.forEach(file => {
            formData.append('files', file, file.name);
        });
        //æ·»åŠ ç›¸å¯¹è·¯å¾„
        formData.append('relativePath', currentPath.join('/'));
        try {
            const sessionId = localStorage.getItem('sessionId');
            let requestUrl = endpointPath + '/folder';
            requestUrl += `;jsessionid=${sessionId}`;
            const response = await fetch(requestUrl, {
                method: 'POST',
                body: formData,
                credentials: "include"
                // ç›‘å¬ä¸Šä¼ è¿›åº¦
            });

            if (!response.ok) {
                throw new Error('ä¸Šä¼ å¤±è´¥');
            }

            const data = await response.json();
            console.log('ä¸Šä¼ æˆåŠŸ', data);
            await initFileList();
        } catch (error) {
            console.error('ä¸Šä¼ é”™è¯¯', error);
        } finally {
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }
    }
    /////////å¤„ç†ä¸Šä¼ æ–‡ä»¶å¤¹
    function handleFolderUpload(input) {
        const files = Array.from(input.files);
        const formData = new FormData();
        let tatolsize = 0;//è®°å½•æ€»å¤§å°
        // æ„å»ºæ–‡ä»¶å¤¹ç»“æ„å’Œæ·»åŠ æ–‡ä»¶åˆ° FormData
        let filestructure = [];
        // è¾…åŠ©å‡½æ•°ï¼Œæ ¹æ®è·¯å¾„åœ¨filestructureæŸ¥æ‰¾æˆ–åˆ›å»ºæ–‡ä»¶å¤¹
        function findOrCreateFolder(folderArray, pathParts) {
            let current = folderArray;
            for (let i = 0; i < pathParts.length; i++) {
                const part = pathParts[i];
                let folder = current.find(item => item.name === part && item.type === 'folder');
                if (!folder) {
                    folder = { name: part, type: 'folder', children: [] };
                    current.push(folder);
                }
                current = folder.children;
            }
            return current;
        }
        //ä¸»å‡½æ•°ï¼Œä¾¿åˆ©æ–‡ä»¶æ„é€ æ–‡ä»¶ç»“æ„ï¼Œè®¡ç®—æ€»å¤§å°ï¼Œå°†æ–‡ä»¶æ·»åŠ åˆ°formdata
        files.forEach(file => {
            const relativePath = file.webkitRelativePath;
            if (relativePath) {
                const pathParts = relativePath.split('/');
                const filename = pathParts.pop(); // ç§»é™¤å¹¶è¿”å›æœ€åä¸€ä¸ªå…ƒç´ ä½œä¸ºæ–‡ä»¶å
                const parentFolder = findOrCreateFolder(filestructure, pathParts);
                // æ·»åŠ æ–‡ä»¶åˆ°çˆ¶æ–‡ä»¶å¤¹
                parentFolder.push({ name: filename, type: 'file' });
            } else {
                // å¤„ç†æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶
                filestructure.push({ name: file.name, type: 'file' });
            }
            tatolsize += file.size;
            formData.append('files', file, file.name);
        });
        //æ·»åŠ å¤§å°
        formData.append('tatolsize', tatolsize);

        //æ·»åŠ ç›¸å¯¹è·¯å¾„
        formData.append('relativePath', currentPath.join('/'));
        //æ·»åŠ æ–‡ä»¶å¤¹ç»“æ„
        formData.append('filestructure', JSON.stringify(filestructure));
        console.log(tatolsize);
        console.log(JSON.stringify(filestructure));
        // å‘é€æ•°æ®åˆ°åç«¯
        const sessionId = localStorage.getItem('sessionId');
        let requestUrl = endpointPath + '/folder';
        requestUrl += `;jsessionid=${sessionId}`;
        fetch(requestUrl, {
            method: 'POST',
            body: formData,
            credentials: "include"

        })
            .then(response => {
                if (response.status == 401) {
                    alert('please login');
                }
                if (!response.ok) {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }

                return response.json();
            })
            .then(data => {
                alert('upload success');
                getFilePathSystemAndInit();
            })
            .catch(error => {
                console.error('ä¸Šä¼ é”™è¯¯', error);
            })
            .finally(() => {
                input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            });
    }
    //éªŒè¯ç©ºé—´å¤Ÿå—
    async function checkSpace(tatolsize) {
        const sessionId = localStorage.getItem('sessionId');
        let requestUrl = endpointPath + '/folder_check';
        requestUrl += `;jsessionid=${sessionId}`;
        try {
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tatolsize: tatolsize
                })
            });

            if (!response.ok) {
                throw new Error('ä¸Šä¼ å¤±è´¥');
            }
            return response.json();
        } catch (error) {
            console.error('ä¸Šä¼ é”™è¯¯', error);
        }
    }
    //////////// å¼€å§‹é‡å‘½å
    function startRename(index){
        // è·å–å½“å‰è·¯å¾„ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿæ•°æ®
        let currentFileSystem = fileSystem;
        currentPath.forEach(pathPart => {
            const folder = currentFileSystem.find(item => item.name === pathPart && item.type === 'folder');
            if (folder) {
                currentFileSystem = folder.children;
            }
        });

        const item = currentFileSystem[index];
        const listItem = document.querySelectorAll('.file-item')[index + (currentPath.length > 0 ? 1 : 0)];
        const nameElement = listItem.querySelector('.file-name');
        const oldName = item.name;

        const input = document.createElement('input');
        input.className = 'rename-input';
        input.value = oldName;
        listItem.replaceChild(input, nameElement);

        const saveBtn = document.createElement('button');
        saveBtn.className = 'rename-btn';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.onclick = () => saveRename(index, input.value, listItem, oldName);
        listItem.replaceChild(saveBtn, listItem.querySelector('.rename-btn'));

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'delete-btn';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.onclick = () => cancelRename(index, listItem, oldName);
        listItem.appendChild(cancelBtn);
    }
    // ä¿å­˜é‡å‘½å
    function saveRename(index, newName, listItem, oldName) {
        if (newName.trim()) {
            // è·å–å½“å‰è·¯å¾„ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿæ•°æ®
            let currentFileSystem = fileSystem;
            currentPath.forEach(pathPart => {
                const folder = currentFileSystem.find(item => item.name === pathPart && item.type === 'folder');
                if (folder) {
                    currentFileSystem = folder.children;
                }
            });

            currentFileSystem[index].name = newName;
            initFileList();
        } else {
            cancelRename(index, listItem, oldName);
        }
    }
    // å–æ¶ˆé‡å‘½å
    function cancelRename(index, listItem, oldName) {
        const nameElement = document.createElement('span');
        nameElement.className = 'file-name';
        nameElement.textContent = oldName;
        listItem.replaceChild(nameElement, listItem.querySelector('.rename-input'));

        const renameBtn = document.createElement('button');
        renameBtn.className = 'rename-btn';
        renameBtn.textContent = 'é‡å‘½å';
        renameBtn.onclick = () => startRename(index);
        listItem.replaceChild(renameBtn, listItem.querySelector('.rename-btn'));

        listItem.removeChild(listItem.querySelector('.delete-btn:last-child'));
    }
    ////////// å•å‡»æ–‡ä»¶é¡¹
    async function clickFileItem(name) {
        try {
            let joincurrentPath = currentPath.join('/');
            //å¦‚æœjoincurrentPathä¸ä¸ºç©ºï¼Œä¸”ä¸ä»¥/ç»“å°¾ï¼Œæ·»åŠ /æ¥æ„é€ åˆæ³•url
            console.log(joincurrentPath);
            if (joincurrentPath.length > 0) {
                joincurrentPath += '/';
            }
            // å¯¹è·¯å¾„å’Œæ–‡ä»¶åè¿›è¡Œ URL ç¼–ç 
            const encodedPath = encodeURIComponent(joincurrentPath);
            const encodedName = encodeURIComponent(name);
            let url = `${endpointPath}/file`;
            //æ·»åŠ æŸ¥è¯¢å‚æ•°
            url += `?filepn=${encodedPath}${encodedName}`;
            console.log(url);
            // å‘é€è¯·æ±‚
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'include'
            });

            if (!response.ok) {
                // åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯å¯¹è±¡ï¼ŒåŒ…å« response å±æ€§
                const customError = new Error(`HTTP error! status: ${response.status}`);
                customError.response = response;
                throw customError;
            }

            // è·å–å“åº”çš„ Blob å¯¹è±¡
            const blob = await response.blob();

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const urlObject = window.URL.createObjectURL(blob);
            // ä»å“åº”å¤´ä¸­è·å–æ–‡ä»¶å
            const contentDisposition = response.headers.get('Content-Disposition');
            console.log(contentDisposition);
            let filenameMatch;
            if (contentDisposition) {
                filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
            }
            console.log(filenameMatch);
            //é…ç½®ä¸‹è½½æŒ‰é’®
            let link = document.getElementById('downloadlink');
            link.textContent = 'ä¸‹è½½';
            link.onclick = () => {
                //é…ç½®ä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = urlObject;
                if (filenameMatch) {
                    a.download = filenameMatch[1];
                }
                a.click();
               window.URL.revokeObjectURL(urlObject);
            }
            //è·å–æ–‡ä»¶ç±»å‹
            let filetype = filenameMatch[1].substring(filenameMatch[1].lastIndexOf('.') + 1);
            //å¦‚æœæ˜¯å¯æ˜¾ç¤ºçš„åˆ™æ˜¾ç¤º
            if (
            //    filetype == 'doc'  || filetype == 'docx' || filetype == 'xls' || filetype == 'xlsx' ||
            // filetype == 'ppt' || filetype == 'pptx' || filetype == 'pdf'||
            filetype == 'txt'||filetype=='jpg'||filetype=='png') {

                let show = document.getElementById('fileshow');
                let showcontent = document.getElementById('fileshowcontent');
                showcontent.innerHTML = '';
                if (filetype === 'txt') {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const textarea = document.createElement('textarea');
                        textarea.value = e.target.result;
                        textarea.style.width = '100%';
                        textarea.style.height = '100%';
                        textarea.style.resize = 'none';
                        showcontent.appendChild(textarea);
                    };
                    reader.readAsText(blob);
                    show.style.display = 'block';
                }
                if(filetype=='jpg'||filetype=='png'){
                    const img = document.createElement('img');
                    img.src = urlObject;
                    img.style.width = '70%';
                    showcontent.appendChild(img);
                    show.style.display = 'block';
                }
                //å¯èƒ½æœ‰ç”¨çš„è¡¨ç¤ºæ–¹æ³•
                // const iframe = document.createElement('iframe');
                // iframe.style.width = '100%';
                // iframe.style.height = '100%';
                // iframe.style.border = 'none';

                // if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(filetype)) {
                //     // ä½¿ç”¨ Microsoft Office Online é¢„è§ˆ Office æ–‡ä»¶
                //     const officeUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(urlObject)}`;
                //     iframe.src = officeUrl;
                // } else if (filetype === 'pdf') {
                //     // ç›´æ¥é¢„è§ˆ PDF æ–‡ä»¶
                //     iframe.src = urlObject;
                // } else if (['jpg', 'png'].includes(filetype)) {
                //     // æ˜¾ç¤ºå›¾ç‰‡
                //     iframe.src = `data:image/${filetype};base64,${await blobToBase64(blob)}`;
                // } else if (filetype === 'txt') {
                //     // æ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶
                //     const reader = new FileReader();
                //     reader.onload = function(e) {
                //         const textContent = e.target.result;
                //         iframe.srcdoc = `
                //             <!DOCTYPE html>
                //             <html>
                //             <head>
                //                 <meta charset="UTF-8">
                //             </head>
                //             <body>
                //                 <pre style="white-space: pre-wrap; padding: 10px;">${textContent}</pre>
                //             </body>
                //             </html>
                //         `;
                //     };
                //     reader.readAsText(blob);
                // }
                // showcontent.appendChild(iframe);
                // show.style.display = 'block';

            } else {
                // è§¦å‘ç‚¹å‡»äº‹ä»¶è¿›è¡Œä¸‹è½½
                link.click();
            }
            console.log(filetype);
        } catch (error) {
            console.error('ä¸‹è½½é”™è¯¯', error);
            errorhandle(error);          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·æç¤ºï¼Œå¦‚æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¼¹çª—
        }
    }
    ////æ›´å¤šæ“ä½œæŒ‰é’®
    function moreOperation(name,type){
        if(type=='file'){
            //æ–‡ä»¶æ“ä½œ
            let moreoperation = document.getElementById('moreoperation');
            moreoperation.style.display = 'block';
            currentFile=name;
        }
        if(type=='folder'){
            //æ–‡ä»¶å¤¹æ“ä½œ
        }
    }
    ////å°å°æ–‡ä»¶
    function sealfile() {
        const sealTime = document.getElementById('sealTime').value;
        if (!sealTime) {
            alert('è¯·é€‰æ‹©å°å°æ—¶é—´');
            return;
        }
        // åç»­å¤„ç†é€»è¾‘ï¼ˆå¦‚æäº¤åˆ°åç«¯ï¼‰
        fetch(`${endpointPath}/sealFile`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                filepath: currentPath.join('/'),
                filename: currentFile,
                sealTime: sealTime
            })
           
        }).then(response=>{
            if(response.ok){
                console.log('å°å°æ–‡ä»¶æˆåŠŸ');
            }
        }) 
        .catch(error=>{
                console.error('å°å°æ–‡ä»¶å¤±è´¥', error);
        })
        console.log(currentPath.join('/'));
        console.log(currentFile);
        console.log(sealTime);
        console.log('å°å°æ—¶é—´:', sealTime);
        alert(`æ–‡ä»¶å·²å°å°ï¼Œæ—¶é—´: ${sealTime}`);
        document.getElementById('moreoperation').style.display = 'none';
    }

    // æ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ•°æ®ï¼Œæ·»åŠ  children å±æ€§æ¥è¡¨ç¤ºå­æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
    let fileSystem = [
        {
            id: '1',
            name: 'æ–‡æ¡£',
            type: 'folder',
            whose: '3390351358@qq.com',
            path: '/æ–‡æ¡£',
            children: [
                { name: 'æŠ¥å‘Š.docx', type: 'file' }
            ]
        },
        {
            name: 'å›¾ç‰‡',
            type: 'folder',
            children: []
        }
    ];
let currentFile;

    // å½“å‰æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œåˆå§‹ä¸ºæ ¹ç›®å½•
    let currentPath = [];

    // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
    async function initFileList() {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';

        try {
            // å‘é€è¯·æ±‚è·å–æ–‡ä»¶åˆ—è¡¨


            // æ ¹æ®å½“å‰è·¯å¾„è·å–å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿæ•°æ®
            let currentFileSystem = fileSystem;
            for (const pathPart of currentPath) {
                const folder = currentFileSystem.find(item =>
                    item.name === pathPart && item.type === 'folder'
                );
                if (folder) {
                    currentFileSystem = folder.children;
                } else {
                    break;
                }
            }

            // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ·»åŠ è¿”å›ä¸Šä¸€çº§çš„æŒ‰é’®
            if (currentPath.length > 0) {
                const backItem = document.createElement('li');
                backItem.className = 'file-item';

                const icon = document.createElement('span');
                icon.className = 'file-icon folder';
                icon.innerHTML = 'ğŸ“';
                backItem.appendChild(icon);

                const name = document.createElement('span');
                name.className = 'file-name';
                name.textContent = '..';
                backItem.onclick = goBack;
                backItem.appendChild(name);

                fileList.appendChild(backItem);
            }
            // éå†æ–‡ä»¶ç³»ç»Ÿæ•°æ®ï¼Œåˆ›å»ºæ–‡ä»¶é¡¹
            currentFileSystem.forEach((item, index) => {
                //ä¸€ä¸ªæ–‡ä»¶æ ä½
                const listItem = document.createElement('li');
                listItem.className = 'file-item';
                //æ–‡ä»¶æ ä½ä¸»ä½“åŒ…æ‹¬icon&name
                const filebody = document.createElement('div');
                filebody.style = "display:inline-block;width: 80% ; white-space: normal;overflow-wrap: break-word;word-break: break-all;"
                listItem.appendChild(filebody);

                const icon = document.createElement('span');
                icon.className = `file-icon ${item.type}`;
                icon.innerHTML = item.type === 'folder' ? 'ğŸ“' : 'ğŸ“„';
                filebody.appendChild(icon);


                const name = document.createElement('span');
                name.className = 'file-name';
                name.textContent = item.name;
                if (item.type === 'folder') {
                    filebody.onclick = () => enterFolder(item.name);
                }
                if (item.type === 'file') {
                    filebody.onclick = () => clickFileItem(item.name);
                }
                filebody.appendChild(name);
                //æ–‡ä»¶æ“ä½œæŒ‰é’®
                const renameBtn = document.createElement('button');
                renameBtn.className = 'rename-btn';
                renameBtn.textContent = 'é‡å‘½å';
                renameBtn.onclick = () => startRename(item.id);
                listItem.appendChild(renameBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.onclick = () => deleteItem(item.name,item.type,item.id);
                listItem.appendChild(deleteBtn);

                const moreBtn = document.createElement('button');
                moreBtn.className = 'more-btn';
                moreBtn.textContent = 'æ›´å¤š';
                moreBtn.onclick = () => moreOperation(item.name,item.type);
                listItem.appendChild(moreBtn);
                fileList.appendChild(listItem);
            });

            // æ›´æ–°å½“å‰è·¯å¾„æ˜¾ç¤º
            const pathDisplay = document.getElementById('path-display');
            pathDisplay.textContent = `å½“å‰è·¯å¾„: /${currentPath.join('/')}`;
        } catch (error) {
            console.error('åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨å‡ºé”™:', error);
        }
    }

    ////// è¿›å…¥æ–‡ä»¶å¤¹
    async function enterFolder(folderName) {
        currentPath.push(folderName);
        await initFileList();
    }

    ////// è¿”å›ä¸Šä¸€çº§
    async function goBack() {
        currentPath.pop();
        await initFileList();
    }
    //////è·å–æ–‡ä»¶è·¯å¾„ç³»ç»Ÿ
    async function getFilePathSystem() {
        // å‘é€æ•°æ®åˆ°åç«¯
        const sessionId = localStorage.getItem('sessionId');
        let requestUrl = endpointPath + '/folder';
        requestUrl += `;jsessionid=${sessionId}`;
        fileSystem = await fetch(requestUrl, {
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        }).then(res => res.json());
    }
    //////è·å–å¹¶åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
    function getFilePathSystemAndInit() {
        getFilePathSystem()
            .then(data => {
                // åˆå§‹åŒ–ç•Œé¢
                initFileList();
            })
            .catch(error => {
                console.error('è·å–æ–‡ä»¶è·¯å¾„å‡ºé”™:', error);
            });
    }
    window.onload = function () {
        getFilePathSystemAndInit();
    };
    console.log('javascriptæ‰§è¡Œå®Œäº†');
</script>

</html>