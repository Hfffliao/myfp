<!DOCTYPE html>
<html lang="zh-CN">
<script>
    // 定义全局变量存储上下文路径
    function getContextPath() {
        const pathName = window.location.pathname;
        console.log('pathName:', pathName);
        // 查找第二个 / 的索引
        const Index = pathName.indexOf('p');
        return pathName.substring(0,Index-1 );
    }
    const contextPath = getContextPath();
    console.log('上下文路径:', contextPath);

    // 动态创建 script 标签并设置 src 属性
    const script = document.createElement('script');
    script.src = contextPath + '/pages/css/hangbege.js';
    document.head.appendChild(script);
    // 动态创建 link 标签并设置 href 属性
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = contextPath + '/pages/css/linyistyle.css';
    document.head.appendChild(link);
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <title>霖依</title>
    <!-- 引入字体图标 -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.2/css/all.min.css">
    <style>
        .card-container {
            max-width: none;
            margin: 0rem;
            font-size: large;
            padding: 5%;
            display: flex;
            /* 水平排列 */
            flex-direction: column;
            /* 允许换行 */
            flex-wrap: wrap;
            gap: 1rem;
            background: rgba(198, 18, 18, 0.5);
            /*justify-content: flex-start;*/
            align-items: center;

        }

        .card1 {
            width: 70%;
            display: flex;
            flex-direction: column;
            /* 允许换行 */
            flex-wrap: wrap;
            gap: 1rem;
            /*justify-content: flex-start;*/
            align-items: flex-start;
        }

        .card-in {
            font-size: 20px;
            width: 300px;
            height: 40px;
            padding: 1px; /* 内边距，调整内容与边框的距离 */
        }

        #area {
            width: 25%;
            height: 50px;
            background-color: #e8d4da;
            font-size: large;
        }

        #area1 {
            width: 25%;
            height: 50px;
            background-color: #e8d4da;
            font-size: large;
        }
    </style>

</head>
<body>

<div id="header"></div>
<main>

    <section class="hero">
        <div class="hero-content">
            <h1>注册账号</h1>
            <div class="hero1"><h2>填写相关信息进行注册</h2></div>
        </div>
    </section>
    <div class="card-container">
        <div id="verificationform" class="card1">
            <h3> 用户名（邮箱地址，用于接收验证码）：</h3>
            <input id="email" type="email" name="username" class="card-in" style="display: block;">
        </div>
        <form  method="post" class="card1" id="registerform">
            <h3> 密码：</h3>
            <input type="password" name="password" class="card-in">
            <h3> 再次输入密码：</h3>
            <input type="password" name="repassword" class="card-in">
            验证码：
            <div class="card1" style="flex-direction: row;width: 100%">
                <input type="text" name="verification" class="card-in" style="width: 200px">
                <input type="button" value="获取验证码" id="area" style="font-size: small;width: 20%;"
                       onclick="startCountdown('area')">
            </div>
            <input type="button" value="注册" id="area1" onclick="register()">
        </form>
    </div>
</main>

<div id="footer"></div>

<script>
    //发送账号密码
    function register(){
        const form = document.getElementById('registerform');
        const formData = new FormData(form);
        fetch(endpointPath+"/register",{
            method: 'POST',
            body: formData,
            credentials: 'include',
        })
        .then(response => {
            if(!response.ok){
                let error = new Error('网络响应失败');
                error.response = response;
                throw error;
            }
            else{
                return response.json();
            }
        })
        .then(responseJson => {
            // 处理服务器响应
            switch (responseJson.status) {
                case "success":
                    alert("注册成功");
                    window.location.href = contextPath + "/pages/in.html";
                    break;
                case "两次密码输入不一致":
                    alert("两次密码输入不一致");
                    break;
                case "验证码输入错误":
                    alert("验证码输入错误");        
                    break;
                case "验证码输入错误次数过多":
                    alert("验证码输入错误次数过多");
                    break;
            }
        })
        .catch(error => {
            console.error('请求出错:', error);
            errorhandle(error);
        });
    }
    // 倒计时控制函数 - 核心解决方案
    function startCountdown(buttonId) {
        // 0. 获取按钮元素
        const button = document.getElementById(buttonId);
        if (!button) return;
        const emailInput = document.getElementById('email');
        const email = emailInput.value;
        // 邮箱格式验证
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('请输入有效的邮箱地址');
            button.disabled = false;
            return;
        }
        // 构建包含邮箱参数的请求 URL
        const url = new URL(endpointPath+"/register");
        url.searchParams.append('username', email);
        // 3. 立即更新按钮状态
        button.disabled = true;

        // 使用 fetch API 发送请求
        fetch(url.toString(), {
            method: 'GET',
            credentials: 'include' // 对应 XMLHttpRequest 的 withCredentials = true
        })
        .then(response => {
            if(!response.ok){
                let error = new Error('网络响应失败');
                error.response = response;
                throw error;
            }
            else{
                return response.text();
            }
        })
        .then(responseText => {
            // 处理服务器响应
            switch (responseText) {
                case "email error":
                    alert("邮箱错误");
                    button.disabled = false;
                    break;
                case "user exist":
                    alert(responseText);
                    button.disabled = false;
                    break;
                case "send success":
                    alert(responseText);
                    // 1. 获取当前时间并保存到 sessionStorage
                    const startTime = new Date().getTime();
                    sessionStorage.setItem(`${buttonId}StartTime`, startTime);
                    // 2. 保存按钮原始文本
                    const originalValue = button.value;
                    sessionStorage.setItem(`${buttonId}OriginalValue`, originalValue);
                    recoveryTimer();
                    break;
                case "send failed":
                    alert(responseText);
                    button.disabled = false;
                    break;
            }
        })
        .catch(error => {
            console.error('请求出错:', error);
            button.disabled = false;
            errorhandle(error);
        });

        // 4. 提交表单获取验证码
    }

    // 页面加载时检查是否有倒计时需要恢复
    window.addEventListener(`DOMContentLoaded`, () => {
        recoveryTimer();
    });

    function cancelTimer() {
        sessionStorage.removeItem(`${buttonId}StartTime`);
        sessionStorage.removeItem(`${buttonId}OriginalValue`);
    }

    function recoveryTimer() {
        // 0. 只检查"获取验证码"按钮
        const buttonId = 'area';
        const button = document.getElementById(buttonId);
        if (!button) return;

        // 1. 尝试获取sessionStorage中的倒计时数据
        const storedStartTime = sessionStorage.getItem(`${buttonId}StartTime`);
        const storedOriginalValue = sessionStorage.getItem(`${buttonId}OriginalValue`);

        // 2. 如果没有存储数据或已过期，则重置按钮状态
        if (!storedStartTime || !storedOriginalValue) {
            button.disabled = false;
            button.value = "获取验证码";
            return;
        }

        // 3. 计算剩余时间
        const startTime = parseInt(storedStartTime);
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        let remaining = Math.max(0, 60 - elapsed);

        // 4. 如果时间已过期
        if (remaining <= 0) {
            // 恢复按钮并清除存储
            button.disabled = false;
            button.value = storedOriginalValue;
            sessionStorage.removeItem(`${buttonId}StartTime`);
            sessionStorage.removeItem(`${buttonId}OriginalValue`);
            return;
        }

        // 5. 更新按钮初始状态
        button.disabled = true;
        button.value = storedOriginalValue + remaining + `s`;

        // 6. 启动倒计时计时器
        const timer = setInterval(() => {
            // 计算新的剩余时间
            const currentElapsed = Math.floor((Date.now() - startTime) / 1000);
            remaining = Math.max(0, 60 - currentElapsed);

            if (remaining > 0) {
                button.value = remaining + `s`;
            } else {
                // 倒计时结束，恢复按钮状态
                clearInterval(timer);
                button.disabled = false;
                button.value = storedOriginalValue;

                // 清除存储的数据
                sessionStorage.removeItem(`${buttonId}StartTime`);
                sessionStorage.removeItem(`${buttonId}OriginalValue`);
            }
        }, 1000); // 每秒更新一次
    }
</script>
<script>
    window.addEventListener('load',init)
    function init(){
        document.querySelector('form').action = endpointPath+ '/register';
    }

</script>
</body>
</html>