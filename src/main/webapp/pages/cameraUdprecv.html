<!-- 这个网页负责用websocket连接到本地node.js服务器，接收视频流并在网页上显示。
node.js接收的数据是一个个自定义数据包，在udp协议上传输，所以该网页有一个自定义的udp协议解析器，用于解析数据包。 -->


<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <title>霖依</title>
    <script>//这部分需要hangbege.js的都要有
    // 定义全局变量存储上下文路径//
    function getContextPath() {
        const pathName = window.location.pathname;
        console.log('pathName:', pathName);
        // 查找第二个 / 的索引
        // 处理可能找不到的情况
        let index = pathName.indexOf("pages");
        if (index !== -1) {
            console.log("找到pages，索引位置:", index);
        } else {
            console.log("未找到pages");
        }
        return pathName.substring(0, index - 1);
    }
    const contextPath = getContextPath();
    console.log('上下文路径:', contextPath);
    // 动态加载页眉页脚脚本的函数
    function loadScript(src, onLoad, onError) {
        const script = document.createElement('script');
        script.src = src;
        script.onload = onLoad;
        script.onerror = onError;
        document.head.appendChild(script);
    }

    // 动态加载样式表的函数
    function loadStylesheet(href, onLoad, onError) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.onload = onLoad;
        link.onerror = onError;
        document.head.appendChild(link);
    }

    // 动态加载udp视频处理脚本的函数
    function loadUdpvideo_resovlerScript(src, onLoad, onError) {
        const script = document.createElement('script');
        script.src = src;
        script.onload = onLoad;
        script.onerror = onError;
        document.head.appendChild(script);
    }
    // 加载 hangbege.js
    loadScript(
        contextPath + '/pages/css/hangbege.js',
        () => console.log('hangbege.js 加载成功'),
        () => console.error('hangbege.js 加载失败')
    );

    // 加载 linyistyle.css
    loadStylesheet(
        contextPath + '/pages/css/linyistyle.css',
        () => console.log('linyistyle.css 加载成功'),
        () => console.error('linyistyle.css 加载失败')
    );
    loadUdpvideo_resovlerScript(
        contextPath + '/pages/css/udpvideo_resovler.js',
        () => {console.log('udpvideo_resovler.js 加载成功');startrec()},
        () => console.error('udpvideo_resovler.js 加载失败')
    );
    </script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.2/css/all.min.css">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <style>
        #status {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        #videoData {
            min-height: 300px;
        }

        .content1 {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dd {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .aa {
            display: flex;
            flex-direction: column;
            /* justify-content: center; */
            align-items: center;
        }

        .vertical-slider {
            writing-mode: vertical-lr;
            direction: rtl;
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            width: 80px;
            height: 500px;
            padding: 0 0px;
            border-radius: 40px;
            outline: none;
        }
    </style>
</head>

<body>
    <div id="header"></div>
    <section class="hero">
        <div class="content1">
            <h2>ESP32实时视频流监控</h2>
            <!-- <div id="status" class="disconnected">未连接到服务器</div> -->
            <div style="display: flex; flex-direction: row; align-items: center;">
                <input type="range" min="-200" max="200" value="0" class="vertical-slider" id="leftSlider"
                    orient="vertical">
                <input type="range" min="5" max="25" value="15" id="upSlider" class="vertical-slider" orient="vertical">
                <div style="display: inline-flex; flex-direction: column;">
                    <img id="videoDat" src="" alt="等待视频数据">
                    <div class="dd"> <button id="leftstartButton" onclick="sendMessageToWebSocket(1)">总前进</button>
                        <button id="leftstopButton" onclick="sendMessageToWebSocket(5)">总停止</button>
                        <button id="rightstartButton" onclick="sendMessageToWebSocket(2)">开始巡逻</button>
                        <button id="rightstopButton" onclick="sendMessageToWebSocket(6)">停止巡逻</button>
                        <div class="aa">

                        </div>
                        <div class="aa">

                        </div>
                    </div>
                    <input type="range" min="-25" max="-5" value="-15" id="diSlider">
                </div>
                <input type="range" min="-200" max="200" value="0" class="vertical-slider" id="rightSlider"
                    orient="vertical">
                <input type="range" min="-200" max="200" value="0" class="vertical-slider" id="straightSlider"
                    orient="vertical">
            </div>
            <!-- pwm相关 -->
            <input type="number" id="analogWriteFreq" name="analogWriteFreq" min="1" max="1000">
            <input type="number" id="analogWriteRange" name="analogWriteRange" min="1" max="255">
            <button id="analogWriteButton" onclick="sendAnalogWrite()">发送 PWM 设置</button>
        </div>
    </section>

    <div id="footer"></div>
    <script>
        const wsUrl_control = 'wss://' + 'linyi.love' + ':443/car-user';
        const websocket_ctrl = new WebSocket(wsUrl_control);
        websocket_ctrl.binaryType = 'arraybuffer';
        const zhiling = new Uint8Array(5);
        function sendMessageToWebSocket(message) {
            if (websocket_ctrl.readyState === WebSocket.OPEN) {

                zhiling[0] = 109;
                zhiling[1] = 111;
                zhiling[2] = 118;
                zhiling[3] = 101;
                zhiling[4] = message;
                websocket_ctrl.send(zhiling);
            } else {
                console.error("WebSocket 连接未打开");
            }
        }
        //滑动杆相关
        const leftSlider = document.getElementById("leftSlider");
        const rightSlider = document.getElementById("rightSlider");
        const upSlider = document.getElementById("upSlider");
        const diSlider = document.getElementById("diSlider");
        const straightSlider = document.getElementById("straightSlider");
        leftSlider.addEventListener("input", function () {
            if (leftSlider.value > 0) {
                sendfuzaMessageToWebSocket(9, leftSlider.value);
            } else {
                sendfuzaMessageToWebSocket(10, -leftSlider.value);
            }

        })
        rightSlider.addEventListener("input", function () {
            if (rightSlider.value > 0) {
                sendfuzaMessageToWebSocket(7, rightSlider.value);
            } else {
                sendfuzaMessageToWebSocket(8, -rightSlider.value);
            }
        })
        upSlider.addEventListener("input", function () {
            sendfuzaMessageToWebSocket(14, upSlider.value);

        })
        diSlider.addEventListener("input", function () {
            sendfuzaMessageToWebSocket(15, -diSlider.value);
        })
        straightSlider.addEventListener("input", function () {
            if (straightSlider.value > 0) {
                sendfuzaMessageToWebSocket(11, straightSlider.value);
            } else {
                sendfuzaMessageToWebSocket(12, -straightSlider.value);
            }
        })
        const fuzazhiling = new Uint8Array(7);
        function sendfuzaMessageToWebSocket(message, speed) {
            if (websocket_ctrl.readyState === WebSocket.OPEN) {

                fuzazhiling[0] = 109;
                fuzazhiling[1] = 111;
                fuzazhiling[2] = 118;
                fuzazhiling[3] = 101;
                fuzazhiling[4] = message;
                // fuzazhiling[5] = speed;//右边
                // fuzazhiling[6] = (speed);//左边
                fuzazhiling[5] = speed;//右边
                fuzazhiling[6] = speed;//左边
                websocket_ctrl.send(fuzazhiling);
            } else {
                console.error("WebSocket 连接未打开");
            }
        }
        //pwm相关
        const analogWriteFreq = document.getElementById("analogWriteFreq");
        const analogWriteRange = document.getElementById("analogWriteRange");
        const pwmzhiling = new Uint8Array(8);
        function sendAnalogWrite() {
            if (websocket_ctrl.readyState === WebSocket.OPEN) {
                pwmzhiling[0] = 109;
                pwmzhiling[1] = 111;
                pwmzhiling[2] = 118;
                pwmzhiling[3] = 101;
                pwmzhiling[4] = 13;
                pwmzhiling[5] = analogWriteFreq.value / 256;
                pwmzhiling[6] = analogWriteFreq.value % 256;
                pwmzhiling[7] = analogWriteRange.value;
                websocket_ctrl.send(pwmzhiling);
            }
        }
        // 在文件顶部添加全局开关
        const LOG_ENABLED = false; // 设为false即可关闭所有日志

        // 替换所有console.log为条件输出
        function log(...args) {
            if (LOG_ENABLED) {
                console.log(...args);
            }
        }


        // // 创建Blob URL 就是udpvideo_resovler.js里的

        function startrec() {
            const imgElement = document.getElementById('videoDat');
            window.imgelement = imgElement;
            const blob = new Blob([workerCode], {type: 'application/javascript'});
            const workerUrl = URL.createObjectURL(blob);
            // 使用内联Worker
            const videoWorker = new Worker(workerUrl);
            window.videoWork = videoWorker; // 显式全局
            //const videoWorker = new Worker('worker.js');

            // 接收Worker处理结果
            videoWorker.onmessage = function (e) {
                const imageData = e.data;
                // console.log("最终处理结果："+e.data);            //console.error("2线程处理好照片交给主线程显示："+Date.now());
                displayImage(imageData, 'image/jpeg');
                // console.log("显示完毕："+Date.now());
            };

            //
            //接收视频数据
            //
/////////////////////////////////////////////////////////////////////////////////
            // 视频流URL
            const wsUrl = 'ws://' + 'localhost' + ':3000';

            // 创建WebSocket连接
            const websocket = new WebSocket(wsUrl);

            websocket.binaryType = 'arraybuffer';

            websocket.onmessage = function (event) {
                //console.error("1线程接到数据:"+Date.now()); // 输出：1725524400000（示例值）
                const data = event.data;
                addmessage(data);
            }
////////////////////////////////////////////

        }
    </script>
</body>

</html>